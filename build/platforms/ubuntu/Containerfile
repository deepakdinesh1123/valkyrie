FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt update && \
    apt install -y adduser xz-utils curl ca-certificates git vim

RUN groupadd -o -g 2048 -r valnix && \
    adduser --uid 2048 --gid 2048 --disabled-password --gecos "" valnix

RUN mkdir /etc/nix && echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
USER valnix
RUN mkdir ~/odin && chown valnix:valnix ~/odin
RUN cd /tmp && git clone --depth 1 --branch 24.05 --single-branch https://github.com/NixOS/nixpkgs.git 

COPY hack/execution/* /home/valnix/

VOLUME [ "/home/valnix" ]
WORKDIR /home/valnix/

CMD [ "/bin/sh", "nix_setup.sh" ]
