FROM {{ .EXEC_IMAGE }} AS builder

FROM {{ .BASE_IMAGE }}

RUN addgroup -g 1024 -S valnix && \
    adduser -u 1024 -G valnix -S -D valnix && \
    mkdir -p /home/valnix/valkyrie

RUN cat <<EOF > "/home/valnix/nix_stop.sh"
#!/usr/bin/env sh

# Get the parent PID of exec.sh
parent_id=$(pgrep -f exec.sh)

echo "Parent PID(s): \$parent_id"

if [ -z "\$parent_id" ]; then
    echo "No process named exec.sh found."
else
    for pid in \$parent_id; do
        # Get child PIDs of the parent PID
        child_pids=$(pgrep -P "\$pid")
        
        for child_pid in \$child_pids; do
            if kill -2 "\$child_pid" 2>/dev/null; then
                echo "Sent SIGINT to process \$child_pid"
            else
                echo "Failed to send SIGINT to process \$child_pid (may not exist)"
            fi
        done
    done
fi
EOF

RUN cat <<EOF > "/home/valnix/nix_run.sh"
#!/usr/bin/env sh

set -e
. ~/.profile
chmod +x ~/valkyrie/exec.sh
cd ~/valkyrie
exec ./exec.sh
EOF


RUN chmod +x /home/valnix/nix_stop.sh /home/valnix/nix_run.sh

USER valnix
WORKDIR /home/valnix

COPY --from=builder --chown=valnix:valnix /nix /nix
COPY --from=builder --chown=valnix:valnix /bin /bin
